FROM {{ image_spec("base-tools") }}
MAINTAINER {{ maintainer }}

COPY redis_sudoers /etc/sudoers.d/redis_sudoers

RUN chmod 750 /etc/sudoers.d && \
    chmod 440 /etc/sudoers.d/redis_sudoers && \
    useradd redis -G microservices && \
    apt-get update && \
    apt-get install --no-install-recommends -y build-essential make gcc curl && \

    src=redis-{{ redis_version }} && \
    curl -L http://download.redis.io/releases/$src.tar.gz -o $src.tar.gz && \
    tar xzf $src.tar.gz && chown -R redis: ./$src && \
    su -c "make -C ./$src" redis && make install -C ./$src && \

    usermod -s /bin/false redis && \
    apt-get remove -y --purge build-essential make gcc && \
    rm -f $src.tar.gz && rm -rf $src && \
    rm -rf /var/lib/apt/lists/* && \
    mkdir /etc/redis && chown -R redis: /etc/redis

USER redis
